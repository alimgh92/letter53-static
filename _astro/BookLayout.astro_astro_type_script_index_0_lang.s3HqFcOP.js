"serviceWorker"in navigator&&window.addEventListener("load",async()=>{try{const e=await navigator.serviceWorker.register("/sw.js");e.addEventListener("updatefound",()=>{const n=e.installing;n&&n.addEventListener("statechange",()=>{n.state==="installed"&&navigator.serviceWorker.controller})})}catch{}});const P=document.getElementById("search-shortcut"),D=document.getElementById("ai-shortcut"),q=navigator.platform.toUpperCase().indexOf("MAC")>=0||navigator.userAgent.toUpperCase().indexOf("MAC")>=0;P&&(P.innerHTML=q?'<span dir="ltr">⌘K</span>':'<span dir="ltr">Ctrl+K</span>');D&&(D.innerHTML=q?'<span dir="ltr">⌘⇧K</span>':'<span dir="ltr">Ctrl+Shift+K</span>');const J=document.getElementById("theme-toggle"),A=["light","dark","sepia"];let $=0;J?.addEventListener("click",()=>{$=($+1)%A.length,document.documentElement.setAttribute("data-theme",A[$]),localStorage.setItem("theme",A[$])});const O=localStorage.getItem("theme");O&&document.documentElement.setAttribute("data-theme",O);const Y=document.getElementById("font-size");let S=18;Y?.addEventListener("click",()=>{S=S>=24?16:S+2,document.documentElement.style.setProperty("--font-size-base",S+"px"),localStorage.setItem("fontSize",S.toString())});const G=document.getElementById("menu-toggle"),b=document.getElementById("sidebar"),M=document.getElementById("sidebar-overlay");function X(){b?.classList.add("active"),M?.classList.add("active"),document.body.style.overflow="hidden"}function H(){b?.classList.remove("active"),M?.classList.remove("active"),document.body.style.overflow=""}G?.addEventListener("click",()=>{b?.classList.contains("active")?H():X()});M?.addEventListener("click",H);document.addEventListener("keydown",e=>{e.key==="Escape"&&(v?.classList.contains("active")?_():b?.classList.contains("active")&&H()),(e.ctrlKey||e.metaKey)&&e.shiftKey&&(e.key==="K"||e.key==="k")&&(e.preventDefault(),z())});const Q=document.getElementById("ai-chat-btn"),v=document.getElementById("ai-chat-modal"),V=document.getElementById("ai-chat-close"),Z=document.getElementById("ai-chat-clear"),c=document.getElementById("ai-chat-input"),I=document.getElementById("ai-chat-send"),h=document.getElementById("ai-chat-messages"),K=document.getElementById("ai-chat-status");let R=0;const ee=20,U="letter53-ai-chat-history";let p=[],g=-1,N="";const x={proxyUrl:window.location.hostname==="localhost"?"http://localhost:8080/proxy":"/api/proxy",apiKey:"",directUrl:""};function te(){if(!h)return;const e=[];h.querySelectorAll(".user-message, .ai-message").forEach(s=>{const a=s.classList.contains("user-message"),l=s.getAttribute("data-raw-content")||s.querySelector(".user-message-content, .ai-message-content")?.textContent||"";l&&l.trim()&&e.push({isUser:a,content:l})}),e.length>0&&localStorage.setItem(U,JSON.stringify(e))}function ne(){if(!h)return;const e=localStorage.getItem(U);if(e)try{const n=JSON.parse(e);p=n.filter(s=>s.isUser).map(s=>s.content),n.forEach(s=>{L(s.content,s.isUser)})}catch(n){console.error("Failed to load chat history:",n),B()}else B()}function B(){L("سلام! من دستیار هوشمند نامه ۵۳ هستم. می‌توانم به شما در درک مطالب کمک کنم. سوال خود را بپرسید.",!1)}function se(){h&&(h.innerHTML=""),localStorage.removeItem(U),B()}async function z(){v?.classList.add("active"),v?.setAttribute("aria-hidden","false"),document.body.style.overflow="hidden",setTimeout(()=>c?.focus(),150),await W(),h&&h.children.length===0&&ne()}function _(){v?.classList.remove("active"),v?.setAttribute("aria-hidden","true"),document.body.style.overflow=""}let f=[];async function W(){try{const n=await(await fetch("/api/search-index.json")).json();n&&n.documents&&(f=n.documents)}catch(e){console.error("Failed to load chapters data:",e)}}function ae(e){if(!f||f.length===0)return e;const n={اول:"1",دوم:"2",سوم:"3",چهارم:"4",پنجم:"5",ششم:"6",هفتم:"7",هشتم:"8",نهم:"9",دهم:"10",یک:"1",دو:"2",سه:"3",چهار:"4",پنج:"5",شش:"6",هفت:"7",هشت:"8",نه:"9",ده:"10"},s={اولین:"1",دومین:"2",سومین:"3",چهارمین:"4",پنجمین:"5",ششمین:"6",هفتمین:"7",هشتمین:"8",نهمین:"9",دهمین:"10"},a=[],l=/(جلسه|جلسات|فصل|بخش)\s*(اول|دوم|سوم|چهارم|پنجم|ششم|هفتم|هشتم|نهم|دهم|یک|دو|سه|چهار|پنج|شش|هفت|هشت|نه|ده|[\d۰-۹]+)/gi;let t;for(;(t=l.exec(e))!==null;){const i=t[2],u=i.replace(/[۰-۹]/g,o=>"۰۱۲۳۴۵۶۷۸۹".indexOf(o).toString()),m=n[i]||u,r=f.find(o=>o.slug===`chapter-${m}`||o.chapter==m);r&&a.push({start:t.index,end:t.index+t[0].length,text:t[0],replacement:`<a href="/chapters/${r.slug}" class="chapter-link">${t[0]}</a>`})}const w=/جلسات?\s*(اول|دوم|سوم|چهارم|پنجم|ششم|هفتم|هشتم|نهم|دهم|یک|دو|سه|چهار|پنج|شش|هفت|هشت|نه|ده|[\d۰-۹]+)/gi;for(;(t=w.exec(e))!==null;){const i=t[1],u=i.replace(/[۰-۹]/g,o=>"۰۱۲۳۴۵۶۷۸۹".indexOf(o).toString()),m=n[i]||u,r=f.find(o=>o.slug===`chapter-${m}`||o.chapter==m);r&&(a.some(d=>t.index>=d.start&&t.index<d.end||t.index+t[0].length>d.start&&t.index+t[0].length<=d.end)||a.push({start:t.index,end:t.index+t[0].length,text:t[0],replacement:`<a href="/chapters/${r.slug}" class="chapter-link">${t[0]}</a>`}))}const y=/و\s*([\d۰-۹]+)/gi;for(;(t=y.exec(e))!==null;){const i=t[1],m=i.replace(/[۰-۹]/g,o=>"۰۱۲۳۴۵۶۷۸۹".indexOf(o).toString()),r=f.find(o=>o.slug===`chapter-${m}`||o.chapter==m);r&&(a.some(d=>t.index>=d.start&&t.index<d.end||t.index+t[0].length>d.start&&t.index+t[0].length<=d.end)||a.push({start:t.index,end:t.index+t[0].length,text:t[0],replacement:`و <a href="/chapters/${r.slug}" class="chapter-link">${i}</a>`}))}const E=/،\s*([\d۰-۹]+|اول|دوم|سوم|چهارم|پنجم|ششم|هفتم|هشتم|نهم|دهم|یک|دو|سه|چهار|پنج|شش|هفت|هشت|نه|ده)/gi;for(;(t=E.exec(e))!==null;){const i=t[1],u=i.replace(/[۰-۹]/g,o=>"۰۱۲۳۴۵۶۷۸۹".indexOf(o).toString()),m=n[i]||u,r=f.find(o=>o.slug===`chapter-${m}`||o.chapter==m);r&&(a.some(d=>t.index>=d.start&&t.index<d.end||t.index+t[0].length>d.start&&t.index+t[0].length<=d.end)||a.push({start:t.index,end:t.index+t[0].length,text:t[0],replacement:`، <a href="/chapters/${r.slug}" class="chapter-link">${i}</a>`}))}const T=/(اولین|دومین|سومین|چهارمین|پنجمین|ششمین|هفتمین|هشتمین|نهمین|دهمین)\s+فصل/gi;for(;(t=T.exec(e))!==null;){const i=t[1],u=s[i],m=f.find(r=>r.slug===`chapter-${u}`||r.chapter==u);m&&(a.some(o=>t.index>=o.start&&t.index<o.end||t.index+t[0].length>o.start&&t.index+t[0].length<=o.end)||a.push({start:t.index,end:t.index+t[0].length,text:t[0],replacement:`<a href="/chapters/${m.slug}" class="chapter-link">${t[0]}</a>`}))}a.sort((i,u)=>u.start-i.start);let k=e;for(const i of a)k=k.substring(0,i.start)+i.replacement+k.substring(i.end);return k}function oe(e){return e=e.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>"),e=e.replace(/__([^_]+)__/g,"<strong>$1</strong>"),e=e.replace(/(?<!\*)\*(?!\*)([^*]+)(?<!\*)\*(?!\*)/g,"<em>$1</em>"),e=e.replace(/(?<!_)_(?!_)([^_]+)(?<!_)_(?!_)/g,"<em>$1</em>"),e=e.replace(/\n\n/g,"</p><p>"),e=e.replace(/\n/g,"<br>"),e.startsWith("<p>")||(e="<p>"+e+"</p>"),e=e.replace(/^- (.+)$/gm,"<li>$1</li>"),e=e.replace(/(<li>.*<\/li>)/s,"<ul>$1</ul>"),e=e.replace(/^\d+\. (.+)$/gm,"<li>$1</li>"),e}function L(e,n=!1){if(!h)return;const s=document.createElement("div");s.className=n?"user-message":"ai-message";const a=document.createElement("div");a.className=n?"user-message-avatar":"ai-message-avatar",a.textContent=n?"👨":"✨";const l=document.createElement("div");if(l.className=n?"user-message-content":"ai-message-content",s.setAttribute("data-raw-content",e),n)l.textContent=e;else{const t=oe(e),w=ae(t);l.innerHTML=w}s.appendChild(a),s.appendChild(l),h.appendChild(s),h.scrollTop=h.scrollHeight,te()}function C(e){K&&(K.textContent=e)}function re(){if(!h)return;const e=document.createElement("div");e.className="thinking-indicator",e.id="thinking-indicator";const n=document.createElement("div");n.className="thinking-avatar",n.textContent="✨";const s=document.createElement("div");s.className="thinking-content";const a=document.createElement("div");a.className="typing-dots";for(let l=0;l<3;l++){const t=document.createElement("span");t.className="typing-dot",a.appendChild(t)}s.appendChild(a),e.appendChild(n),e.appendChild(s),h.appendChild(e),h.scrollTop=h.scrollHeight}function j(){const e=document.getElementById("thinking-indicator");e&&e.remove()}async function F(e){if(R>=ee){C("دستیار هوشمند موقتاً در دسترس نیست. لطفاً از جستجوی ساده استفاده کنید.");return}L(e,!0),p.push(e),g=p.length,c&&(c.value=""),I&&I.setAttribute("disabled","true"),re(),C("");try{const s=await(await fetch(`/api/search-index.json?t=${Date.now()}`)).json();let a="",l=0;s&&s.documents&&(l=s.documents.length,a=`محتوای کامل کتاب:

`,s.documents.forEach(r=>{a+=`===== جلسه ${r.chapter}: ${r.title} =====
`,a+=`${r.content}

`})),R++;const t=x.proxyUrl&&x.proxyUrl.length>0,w=t?x.proxyUrl:x.directUrl,y={"Content-Type":"application/json"};t||(y.Authorization=`Bearer ${x.apiKey}`,y["HTTP-Referer"]=window.location.origin,y["X-Title"]="Letter53 Book");const E=[];E.push({role:"system",content:`شما دستیار کتاب "نامه ۵۳" هستید. 

${l<46?`توجه مهم: از کل کتاب (۴۶ جلسه)، تاکنون ${l.toString().replace(/\d/g,r=>"۰۱۲۳۴۵۶۷۸۹"[r])} فصل منتشر شده است. 
در ابتدای پاسخ‌هایتان خیلی کوتاه اشاره کنید: "⚠️ این پاسخ بر اساس ${l.toString().replace(/\d/g,r=>"۰۱۲۳۴۵۶۷۸۹"[r])} فصل منتشر شده از ۴۶ فصل تولید شده است."

`:""}قوانین بسیار مهم:
1. وقتی درباره محتوای نامه ۵۳ توضیح می‌دهید، فقط از این کتاب استفاده کنید
2. برای سوالات عمومی، از دانش کامل خود استفاده کنید (تاریخ، جغرافیا، افراد مشهور، علوم و...)
3. برای مقایسه‌ها و تحلیل‌ها، آزادانه از دانش عمومی استفاده کنید
4. اگر سوالی مستقیماً درباره محتوای نامه ۵۳ است و در کتاب نیست، بگویید: "این موضوع در کتاب بررسی نشده"
5. به فارسی پاسخ دهید
6. همیشه در انتهای پاسخ، به فصل‌هایی که محتوا از آنها استخراج شده به صورت خلاصه اشاره کنید (مثال: 📚 منبع: جلسه ۲ و ۳)

قوانین نگارشی الزامی:
- هرگز از (ع) یا (ص) یا (س) استفاده نکنید
- برای امامان: علیه السلام یا علیهم السلام
- برای پیامبر: صلی الله علیه و آله
- برای حضرت زهرا: سلام الله علیها
- همیشه عبارات کامل را بنویسید، نه مخفف
- هیچ‌وقت از اعداد لاتین (0123456789) استفاده نکنید
- همیشه از ارقام فارسی (۰۱۲۳۴۵۶۷۸۹) استفاده کنید

نحوه پاسخ‌دهی:
- به صورت پیش‌فرض، پاسخ‌های کامل و با جزئیات ارائه دهید
- نکات مهم را توضیح دهید
- از مثال‌های موجود در کتاب استفاده کنید
- اگر کاربر کلمات "خلاصه"، "مختصر" یا "کوتاه" را به کار برد، پاسخ کوتاه دهید
- اگر کاربر خواست "بیشتر توضیح بده" یا "کامل‌تر"، با جزئیات بیشتر پاسخ دهید
- همیشه به فصل مربوطه اشاره کنید

${a||"محتوای کتاب یافت نشد."}`});const T=h?.querySelectorAll(".user-message, .ai-message")||[];Array.from(T).slice(-10).forEach(r=>{const o=r.classList.contains("user-message"),d=r.querySelector(".user-message-content, .ai-message-content")?.textContent;d&&d.trim()&&E.push({role:o?"user":"assistant",content:d.trim()})}),E.push({role:"user",content:e});const i=await fetch(w,{method:"POST",headers:y,body:JSON.stringify({model:"google/gemini-flash-1.5-8b",messages:E})});if(!i.ok)throw new Error(`API Error: ${i.status}`);const m=(await i.json()).choices?.[0]?.message?.content||"متأسفانه پاسخی دریافت نشد.";j(),L(m,!1),C("")}catch(n){console.error("=== AI Chat Error ==="),console.error("Error:",n),console.error("Error Message:",n.message),console.error("API URL:",apiUrl),console.error("Using Proxy:",isUsingProxy),console.error("Time:",new Date().toLocaleString("fa-IR")),console.error("=================="),j();let s="متأسفانه خطایی رخ داده است. لطفاً دوباره تلاش کنید یا از جستجوی ساده استفاده کنید.";n instanceof TypeError&&n.message.includes("fetch")?(s="عدم اتصال به اینترنت. لطفاً اتصال خود را بررسی کنید یا از جستجوی ساده استفاده کنید.",C("عدم اتصال به اینترنت"),console.error("Possible cause: Proxy server not running at",apiUrl)):navigator.onLine?(C("خطا در اتصال به سرویس هوش مصنوعی"),console.error("Check if proxy server is running at:",apiUrl)):(s="شما آفلاین هستید. برای استفاده از هوش مصنوعی نیاز به اتصال اینترنت دارید. می‌توانید از جستجوی ساده استفاده کنید.",C("حالت آفلاین")),L(s)}finally{I&&I.removeAttribute("disabled")}}W();Q?.addEventListener("click",z);V?.addEventListener("click",_);Z?.addEventListener("click",se);v?.addEventListener("click",e=>{e.target===v&&_()});I?.addEventListener("click",()=>{const e=c?.value.trim();e&&F(e)});c?.addEventListener("input",()=>{g<p.length&&(g=p.length,N=c.value)});c?.addEventListener("keydown",e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();const n=c.value.trim();n&&F(n)}else e.key==="ArrowUp"&&c.selectionStart===0?(e.preventDefault(),g===p.length&&(N=c.value),g>0&&(g--,c.value=p[g],setTimeout(()=>{c.selectionStart=c.selectionEnd=c.value.length},0))):e.key==="ArrowDown"&&(e.preventDefault(),g<p.length-1?(g++,c.value=p[g]):g===p.length-1&&(g=p.length,c.value=N),setTimeout(()=>{c.selectionStart=c.selectionEnd=c.value.length},0))});window.addEventListener("scroll",()=>{const e=document.body.scrollTop||document.documentElement.scrollTop,n=document.documentElement.scrollHeight-document.documentElement.clientHeight,s=e/n*100,a=document.querySelector(".progress-bar");a&&(a.style.width=s+"%")});
